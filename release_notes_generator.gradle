task releaseNotes {
    doLast {
        println("Generating release notes")
        def lastTag = "git describe --tags --abbrev=0".execute().text.trim()
        def count = lastTag.isEmpty() ? 1 : lastTag.split("_")[1].toInteger() + 1
        def tag = "beta_$count"
        def releaseTitle = "Beta $count - Released on ${new Date().format("dd-MM-yyyy")}"
        def commitMessages = commitMessagesSince(lastTag)

        def result = new StringBuilder(releaseTitle).append("\n").append(commitMessages).toString()
        createTag(tag, result)
    }
}

private void createTag(String tag, String message) {
    println(tag)
    println(message)
    ["git", "tag", "-a", tag, "-m", message].execute()
}

private static String commitMessagesSince(String lastTag) {
    def output
    if (lastTag.trim().isEmpty()) {
        output = ["git", "log", "--oneline"].execute().text.trim()
    } else {
        output = ["git", "log", "$lastTag..HEAD", "--oneline"].execute().text.trim()
    }
    def linesBuilder = new StringBuilder()
    def lines = output.toString().split("\n")
    lines.each { line ->
        if (line.trim().isEmpty()) {
            throw new GradleException("No new commits since the last tag")
        } else {
            linesBuilder.append("- ").append(line.split(" ", 2)[1]).append("\n")
        }
    }
    return linesBuilder.toString()
}
